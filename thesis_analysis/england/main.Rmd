---
title: "england"
author: "Theo Rashid"
date: "16/01/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## cause rates

```{r imports}
library(here)
library(tidyverse)
library(abind)
library(cowplot)
library(colorspace)
library(scales)
library(geojsonsf)
library(sf)
library(ggridges)

source(here("thesis_analysis", "theme_thesis.R"))
```

## data

```{r data}
args <- lst(region = "MSOA", model = "nested_as_at")

e0 <- abind(
  read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_female_",
        args$model,
        "_e0.rds"
      )
    )
  ),
  read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_male_",
        args$model,
        "_e0.rds"
      )
    )
  ),
  along = 0,
  new.names = c("female", "male")
)
```

```{r calculate median e0 in over time}
median_e0 <- apply(
  X = e0,
  MARGIN = c(1, 2, 3),
  FUN = median
) |>
  as.data.frame.table(stringsAsFactors = FALSE) |>
  as_tibble() |>
  rename(`e0` = Freq, sex = Var1, year = Var2, MSOA2011 = Var3) |>
  mutate(year = as.integer(year)) |>
  arrange()
```

```{r calculate median e0 change 2002-2019}
median_e0_change <- apply(
  X = e0[, "2019", , ] - e0[, "2002", , ],
  MARGIN = c(1, 2),
  FUN = median
) |>
  as.data.frame.table(stringsAsFactors = FALSE) |>
  as_tibble() |>
  rename(de0 = Freq)
```

```{r calculate change 2002, 2006, 2010, 2014, 2019}
median_e0_changes <- apply(
  X = e0[, c("2002", "2006", "2010", "2014", "2019"), , ],
  MARGIN = c(1, 3, 4),
  FUN = diff
) |>
  apply(
    MARGIN = c(1, 2, 3),
    FUN = median
  ) |>
  as.data.frame.table(stringsAsFactors = FALSE) |>
  as_tibble() |>
  rename(de0 = Freq, year = Var1, sex = Var2, MSOA2011 = Var3) |>
  mutate(
    period = recode(year, `2006` = "2002-2006", `2010` = "2006-2010", `2014` = "2010-2014", `2019` = "2014-2019")
  ) |>
  left_join(
    median_e0 |>
      filter(year == 2002 | year == 2006 | year == 2010 | year == 2014) |>
      group_by(sex, year) |>
      mutate(percentile = ntile(e0, 100) / 100) |>
      ungroup() |>
      mutate(
        period = recode(year, `2002` = "2002-2006", `2006` = "2006-2010", `2010` = "2010-2014", `2014` = "2014-2019")
      ) |>
      select(-e0, -year)
  )
```

```{r e0 jitter change plot}
p <- ggplot(
  data = median_e0_changes |>
    group_by(sex, period) |>
    summarise(
      pct1  = quantile(de0, p = 0.01),
      pct5  = quantile(de0, p = 0.05),
      pct25 = quantile(de0, p = 0.25),
      pct50 = quantile(de0, p = 0.50),
      pct75 = quantile(de0, p = 0.75),
      pct95 = quantile(de0, p = 0.95),
      pct99 = quantile(de0, p = 0.99)
    ),
  aes(x = period)
) +
  geom_hline(yintercept = 0, linewidth = 0.05, alpha = 0.5) +
  geom_crossbar(
    aes(ymin = pct25, y = pct50, ymax = pct75),
    linewidth = 0.2,
    width = 0.3,
    colour = "grey25"
  ) +
  geom_errorbar(
    aes(ymin = pct5, ymax = pct95),
    linewidth = 0.2,
    width = 0.2,
    colour = "grey25"
  ) +
  geom_errorbar(
    aes(ymin = pct1, ymax = pct99),
    linewidth = 0.2,
    width = 0.1,
    colour = "grey25"
  ) +
  geom_jitter(
    data = median_e0_changes,
    aes(x = period, y = de0, colour = percentile),
    size = 0.01,
    alpha = 0.1,
    width = 0.4
  ) +
  facet_wrap(~sex) +
  scale_colour_continuous_divergingx(
    palette = "Zissou",
    name = "Percentile of life expectancy at the start of each time period",
    mid = 0.5,
    rev = TRUE,
    limits = c(0, 1),
    labels = percent
  ) +
  labs(
    x = "Time period",
    y = "Life expectancy change during period (years)"
  ) +
  theme_thesis() +
  theme(
    axis.ticks.x = element_blank(),
    axis.line = element_blank(),
    panel.border = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    legend.direction = "horizontal",
    legend.position = "bottom",
    legend.key.width = unit(30, units = "pt"),
    legend.key.height = unit(5, units = "pt"),
    legend.title = element_text(
      size = 5,
      face = "bold"
    )
  ) +
  guides(
    colour = guide_colourbar(
      title.position = "top",
      title.hjust = 0
    )
  )

save_plot(
  here(
    "thesis_analysis",
    "england",
    "figures",
    "change.pdf"
  ),
  p
)
```
