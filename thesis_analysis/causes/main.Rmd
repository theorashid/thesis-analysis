---
title: "causes"
author: "Theo Rashid"
date: "20/03/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## cause rates

```{r imports}
library(here)
library(tidyverse)
library(abind)
library(cowplot)
library(colorspace)
library(scales)
library(geojsonsf)
library(sf)
library(ggridges)
library(treemap)

source(here("thesis_analysis", "theme_thesis.R"))
source(here("thesis_analysis", "palette_thesis.R"))
source(here("thesis_analysis", "skeletons.R"))
```

## data

```{r data}
args <- lst(region = "LAD", model = "car_as_at")

sexes <- c("female", "male")

e0 <- abind(
  read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_female_",
        args$model,
        "_e0.rds"
      )
    )
  ),
  read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_male_",
        args$model,
        "_e0.rds"
      )
    )
  ),
  along = 0,
  new.names = sexes
)

dimnames(e0) <- list(
  sex = dimnames(e0)[[1]],
  year = dimnames(e0)[[2]],
  LAD2020 = dimnames(e0)[[3]],
  sample = dimnames(e0)[[4]]
)

cause_q <- lst(
  male = read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_male_",
        args$model,
        "_causes_80q0.rds"
      )
    )
  ),
  female = read_rds(
    here(
      "data",
      "life_table",
      str_c(
        args$region,
        "_female_",
        args$model,
        "_causes_80q0.rds"
      )
    )
  )
)
```

```{r covariate and shape data}
shape <- geojson_sf(here("data", "covariates", "LAD2020_ENG_BGC.geojson"))
```

```{r calculate median e0 in over time}
median_e0 <- apply(
  X = e0,
  MARGIN = c(1, 2, 3),
  FUN = median
) |>
  as.data.frame.table(stringsAsFactors = FALSE) |>
  as_tibble() |>
  rename(`e0` = Freq) |>
  mutate(year = as.integer(year)) |>
  arrange()
```

```{r calculate median e0 change 2002-2019}
median_e0_change <- apply(
  X = e0[, "2019", , ] - e0[, "2010", , ],
  MARGIN = c(1, 2),
  FUN = median
) |>
  as.data.frame.table(stringsAsFactors = FALSE) |>
  as_tibble() |>
  rename(de0 = Freq)
```

```{r median of changes}
median_e0 |>
  filter(year == 2010 | year == 2019) |>
  group_by(sex, LAD2020) |>
  summarise(de0 = diff(e0)) |>
  arrange(de0)
```

```{r calculate median 80q0 over time}
median_q <- lst()
for (s in c("male", "female")) {
  median_q[[s]] <- apply(
    X = cause_q[[s]],
    MARGIN = c(1, 2, 4),
    FUN = median
  ) |>
    as.data.frame.table(stringsAsFactors = FALSE) |>
    as_tibble() |>
    rename(`80q0` = Freq) |>
    mutate(year = as.integer(year)) |>
    arrange()
}
```

```{r calculate median 80q0 relative change 2002-2019}
median_q_rel_change <- lst()
for (s in c("male", "female")) {
  median_q_rel_change[[s]] <- apply(
    X = (cause_q[[s]]["2019", , , ] - cause_q[[s]]["2002", , , ]) / cause_q[[s]]["2002", , , ],
    MARGIN = c(1, 3),
    FUN = median
  ) |>
    as.data.frame.table(stringsAsFactors = FALSE) |>
    as_tibble() |>
    rename(d80q0 = Freq)
}
```

## treemap

```{r cause names}
cause_names <- tribble(
  ~cause, ~group, ~cause_lab, ~type, ~which_sex,
  "Trachea bronchus lung cancers", "Trachea, bronchus, lung cancers", "Trachea, bronchus, lung cancers", "cancer", "both",
  "Colon and rectum cancers", "Colon and rectum cancers", "Colorectal cancers", "cancer", "both",
  "Breast cancer", "Breast cancer", "Breast cancer", "cancer", "female",
  "Ovary cancer", "Ovary cancer", "Ovarian cancer", "cancer", "female",
  "Oesophagus cancer", "Oesophagus cancer", "Oesophageal cancer", "cancer", "male",
  "Prostate cancer", "Prostate cancer", "Prostate cancer", "cancer", "male",
  "Pancreas cancer", "Pancreas cancer", "Pancreatic cancer", "cancer", "female",
  "Lymphomas multiple myeloma", "Lymphomas, multiple myeloma", "Lymphomas, multiple myeloma", "cancer", "both",
  "All other cancers", "All other cancers", "All other cancers", "cancer", "both",
  "Ischaemic heart disease", "Ischaemic heart disease", "Ischaemic heart disease", "CVD", "both",
  "Cerebrovascular disease", "Cerebrovascular disease", "Stroke", "CVD", "both",
  "All other CVD", "All other CVD", "All other CVD", "CVD", "both",
  "Alzheimer and other dementias", "Alzheimer and other dementias", "Alzheimer's and other dementias", "NCD", "both",
  "Chronic obstructive pulmonary disease", "Chronic obstructive pulmonary disease", "COPD", "NCD", "both",
  "Cirrhosis of the liver", "Cirrhosis of the liver", "Liver cirrhosis", "NCD", "male",
  "Diabetes mellitus nephritis and nephrosis", "Diabetes mellitus, nephritis and nephrosis", "Diabetes", "NCD", "both",
  "All other NCD", "All other NCD", "All other NCD", "NCD", "both",
  "Lower respiratory infections", "Lower respiratory infections", "Lower respiratory infections", "GBD Group 1", "both",
  "All other infections maternal perinatal and nutritional conditions",
  "All other infections, maternal, perinatal and nutritional conditions",
  "All other group 1",
  "GBD Group 1", "both",
  "External causes", "External causes", "Injuries", "Injuries", "both"
)
```

```{r tree map}
tm_df <- read_csv(here("data", "eda", "deaths_eng_cs.csv")) |>
  mutate(sex = recode(sex, `1` = "men", `2` = "women")) |>
  left_join(cause_names)

p <- tm_df |>
  mutate(
    lab = str_c(
      cause_lab,
      "\n",
      format(deaths, big.mark = ","),
      "\n(",
      format(round(deaths_prop, 1), nsmall = 1),
      "%)"
    )
  ) |>
  treemap(
    index = c("sex", "lab"),
    type = "categorical",
    vSize = "deaths",
    vColor = "type",
    palette = cause_group_pal,
    fontsize.labels = 10,
    fontsize.title = 0,
    position.legend = "none",
    bg.labels = 0,
    align.labels = list(
      c("left", "top"),
      c("right", "bottom")
    ),
  )

quartz.save(
  here(
    "thesis_analysis",
    "causes",
    "figures",
    "treemap.pdf"
  ),
  type = "pdf"
)
```

## maps of 80q0

Maps of 80q0 in 2019 and d80q0 2002-19.
```{r map 80q0}
for (s in sexes) {
  cause_list <- cause_names |>
    filter(which_sex == "both" | which_sex == s) |>
    pull(cause)
  for (disease in cause_list) {
    print(disease)
    disease_label <- cause_names |>
      filter(cause == disease) |>
      pull(cause_lab)
    map <- shape |>
      left_join(
        median_q |>
          pluck(s) |>
          filter(year == 2019) |>
          filter(cause == disease) |>
          mutate(LAD2020 = LAD)
      ) |>
      ggplot(aes(fill = `80q0`)) +
      map_skeleton +
      scale_fill_continuous_sequential(
        palette = "Reds",
        name = ""
      )

    p <- median_q |>
      pluck(s) |>
      filter(year == 2019) |>
      filter(cause == disease) |>
      ggplot(aes(x = `80q0`, y = 1, fill = after_stat(x))) +
      ridge_skeleton +
      scale_fill_continuous_sequential(
        palette = "Reds",
        name = str_c("Probability of dying for \n", disease_label),
        breaks = breaks_pretty(n = 3)
      )

    range_change <- median_q_rel_change |>
      pluck(s) |>
      filter(cause == disease) |>
      pull(d80q0) |>
      range() |>
      sign() |>
      sum()

    if (range_change == 0) {
      change_mp <- 0
    } else if (range_change < 0) {
      change_mp <- median_q_rel_change |>
        pluck(s) |>
        filter(cause == disease) |>
        pull(d80q0) |>
        max()
    } else {
      change_mp <- median_q_rel_change |>
        pluck(s) |>
        filter(cause == disease) |>
        pull(d80q0) |>
        min()
    }

    map_change <- shape |>
      left_join(
        median_q_rel_change |>
          pluck(s) |>
          filter(cause == disease) |>
          mutate(LAD2020 = LAD)
      ) |>
      ggplot(aes(fill = `d80q0`)) +
      map_skeleton +
      scale_fill_continuous_divergingx(
        palette = "Geyser",
        mid = change_mp,
        name = "",
        labels = percent
      )

    p_change <- median_q_rel_change |>
      pluck(s) |>
      filter(cause == disease) |>
      ggplot(aes(x = `d80q0`, y = 1, fill = after_stat(x))) +
      ridge_skeleton +
      scale_fill_continuous_divergingx(
        palette = "Geyser",
        mid = change_mp,
        name = str_c("Change in probability for \n", disease_label),
        labels = percent,
        breaks = breaks_pretty(n = 3)
      )

    grid <- plot_grid(map, map_change)

    grid <- ggdraw(grid) +
      draw_plot(p, -0.35, -0.15, scale = 0.11) +
      draw_plot(p_change, 0.15, -0.15, scale = 0.11)

    save_plot(
      here(
        "thesis_analysis",
        "causes",
        "figures",
        str_c(s, "_map_", str_replace_all(disease, " ", "_"), ".pdf")
      ),
      grid
    )
  }
}
```

## cause decomposition

```{r decomposition 2002-19}
for (s in sexes) {
  if (s == "female") id <- 2 else id <- 1
  for (y1 in c(2002, 2010)) {
    for (y2 in c(2010, 2019)) {
      if (y1 != y2) {
        e0_decompose <- read_rds(
          here(
            "data",
            "life_table",
            str_c(
              args$region,
              "_",
              s,
              "_",
              args$model,
              "_e0_decompose",
              y1,
              y2,
              ".rds"
            )
          )
        )

        e0_change <- e0_decompose |>
          as.data.frame.table(stringsAsFactors = FALSE) |>
          as_tibble() |>
          rename(Dx = Freq) |>
          group_by(LAD) |>
          summarise(de0 = sum(Dx)) |>
          arrange(de0)

        p_e0_change <- e0_change |>
          mutate(LAD = factor(LAD, levels = e0_change$LAD)) |>
          ggplot(aes(x = de0, y = LAD)) +
          geom_segment(aes(yend = LAD, x = 0, xend = de0), linewidth = 0.1, colour = "#CCCCCC", alpha = 0.4) +
          geom_point(color = sex_pal[id], size = 0.1) +
          labs(x = str_c("Life expectancy change\n", y1, "-", y2), y = "") +
          theme_thesis() +
          theme(
            axis.title.x = element_text(size = 4, vjust = +40),
            axis.ticks.y = element_blank(),
            axis.text.y = element_blank(),
            axis.line.y = element_blank()
          )

        p_decompose <- e0_decompose |>
          as.data.frame.table(stringsAsFactors = FALSE) |>
          as_tibble() |>
          rename(Dx = Freq) |>
          mutate(LAD = factor(LAD, levels = e0_change$LAD)) |>
          left_join(cause_names) |>
          mutate(cause_lab = factor(str_wrap(cause_lab, 18), levels = str_wrap(cause_names$cause_lab, 18))) |>
          ggplot(aes(x = cause_lab, y = LAD, fill = Dx)) +
          geom_tile(colour = NA) +
          scale_fill_continuous_divergingx(
            palette = "TealRose",
            rev = TRUE,
            mid = 0,
            name = "Contribution to change\n in life expectancy (years)"
          ) +
          labs(x = "", y = "") +
          theme_thesis() +
          theme(
            axis.ticks.y = element_blank(),
            axis.text.y = element_blank(),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
            legend.direction = "horizontal",
            legend.key.width = unit(12, units = "pt"),
            legend.key.height = unit(4, units = "pt"),
            legend.text = element_text(size = 4),
            legend.title = element_text(
              size = 4,
              face = "bold"
            )
          ) +
          guides(
            fill = guide_colorbar(
              title.position = "top",
              title.hjust = 0
            )
          )

        p_hist <- e0_decompose |>
          as.data.frame.table(stringsAsFactors = FALSE) |>
          as_tibble() |>
          rename(Dx = Freq) |>
          group_by(cause) |>
          summarise(sum_Dx = sum(Dx)) |>
          left_join(cause_names) |>
          mutate(cause_lab = factor(cause_lab, levels = cause_names$cause_lab)) |>
          ggplot(aes(x = cause_lab, y = sum_Dx, fill = ifelse(sum_Dx > 0, "+ve", "-ve"))) +
          geom_bar(stat = "identity", alpha = 0.4, linewidth = NA) +
          scale_fill_manual(values = c("darkred", "darkgreen"), name = "") +
          labs(x = "", y = "Total contribution across districts (years)") +
          theme_thesis() +
          theme(
            axis.ticks.x = element_blank(),
            axis.text.x = element_blank(),
            axis.line.x = element_blank(),
            axis.title.y = element_text(size = 4),
            legend.position = "none"
          )

        legend <- get_legend(p_decompose)

        grid <- plot_grid(
          NULL, NULL, p_hist,
          NULL, NULL, NULL,
          p_e0_change, NULL, p_decompose + theme(legend.position = "none"),
          ncol = 3,
          rel_heights = c(5, -1.5, 10),
          rel_widths = c(1.4, -0.4, 4),
          align = "vh"
        ) +
          draw_grob(legend, 0.38, 0.26, 0.1, 1)

        save_plot(
          here(
            "thesis_analysis",
            "causes",
            "figures",
            str_c(s, "_decompose_", y1, "_", y2, ".pdf")
          ),
          grid,
          base_height = 6.00,
          base_width = 3.71
        )
      }
    }
  }
}
```
